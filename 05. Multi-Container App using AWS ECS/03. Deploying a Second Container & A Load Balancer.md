# ðŸš€ **Deploying a Second Container & Adding a Load Balancer**

--> Walking through **deploying a second container (MongoDB)** in AWS ECS, connecting it with your backend container, and configuring an **Application Load Balancer (ALB)** for public access.

---

## **1. Adding the MongoDB Container to the Task Definition**

You extend the existing ECS task definition:

### âž¤ **Container Configuration**

* **Name:** `MongoDB`
* **Image:** `mongo` (official Docker Hub image; ECS automatically pulls it)
* **Port Mapping:**

  * Map **container port 27017**
* **Environment Variables:**
  Taken from `mongo.env`:

  * `MONGO_INITDB_ROOT_USERNAME=nidhal`
  * `MONGO_INITDB_ROOT_PASSWORD=secret`

### âž¤ **Volumes**

* Your `docker-compose` uses a volume for data persistence.
* In this initial setup, **you skip adding a volume in AWS**, but it will be added later.

After saving, the **task definition now includes two containers**:

* Node backend
* MongoDB

---

## **2. Creating the ECS Service**

You now deploy the containers.

### âž¤ **Service Configuration**

* **Cluster:** `goals-app`
* **Launch type:** `Fargate`
* **Task definition:** the one just created
* **Service name:** e.g. `goals_service`
* **Number of tasks:** `1`

---

## **3. Networking Setup**

### âž¤ **VPC & Subnets**

* Select a VPC
* Choose **both subnets**
* Enable **Auto-assign Public IP = ENABLED**

  * Needed for public access

---

## **4. Adding an Application Load Balancer (ALB)**

Since no ALB exists yet, you must create one manually via EC2 Console.

### âž¤ **ALB Configuration**

* **Name:** `ecs-lb`
* **Type:** Internet-facing
* **Port:** Listener on port **80 (HTTP)**
* **VPC:** Must match the service VPC
* **AZ/Subnets:** Use the same subnets as the service

### âž¤ **Security Groups**

* Use an existing security group that allows HTTP traffic on port 80.

### âž¤ **Target Group**

* **Type:** IP (required for Fargate)
* **Port:** 80
* ALB will auto-register ECS tasks that start

After creation, return to ECS and select this ALB for the service.

---

## **5. Finish ECS Service Setup**

* Select the load balancer you created
* Attach the backend container mapping (80:80) to the target group
* Skip auto scaling for now
* Create the service

AWS now:

* Starts the tasks
* Registers them with the ALB
* Assigns a public IP

---

## **6. Testing the Deployment**

Once both containers show **Running**:

### âž¤ **Get all goals**

```
GET <PUBLIC-IP>/goals
```

You should see:

```json
[]
```

### âž¤ **Create a goal (POST)**

Use Postman:

```
POST <PUBLIC-IP>/goals
Content-Type: application/json
Body: { "text": "first test" }
```

### âž¤ **Delete goal**

```
DELETE <PUBLIC-IP>/goals/<goalId>
```

All operations return expected responses â†’ **deployment successful**.

---

# âœ… **What You Achieved**

By the end of this lecture, you successfully:

âœ” Deployed a **multi-container app** (Node backend + MongoDB)
âœ” Configured an **ECS Fargate service**
âœ” Created and connected an **Application Load Balancer**
âœ” Confirmed that API requests work for GET, POST, DELETE
âœ” Ensured containers are publicly accessible and automatically managed
